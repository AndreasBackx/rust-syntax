$schema: https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json
name: Rust
fileTypes:
  - rs
scopeName: source.rust
patterns:
  - include: '#comments'
  - include: '#keywords'
  - include: '#lifetimes'
  - include: '#punctuation'
  - include: '#strings'
  -
    comment: inferred types, wildcard patterns
    name: comment.char.underscore.rust
    match: \b_\b
  # TODO: capture * as wildcard syntax in use declarations
  # TODO: capture <> as punctuation when used in type declarations
  # strings
  # variables
  -
    comment: self
    name: variable.language.self.rust
    match: \b[Ss]elf\b
  # constants
  # constant.numeric
  -
    comment: decimal integers and floats
    name: constant.numeric.decimal.rust
    match: \b\d[\d_]*(\.?)[\d_]*(?:(E)([+-])([\d_]+))?(f32|f64|i128|i16|i32|i64|i8|isize|u128|u16|u32|u64|u8|usize)?\b
    captures:
      1:
        name: punctuation.separator.dot.decimal.rust
      2:
        name: keyword.operator.exponent.rust
      3:
        name: keyword.operator.exponent.sign.rust
      4:
        name: constant.numeric.decimal.exponent.mantissa.rust
      5:
        name: entity.name.type.numeric.rust
  -
    comment: hexadecimal integers
    name: constant.numeric.hex.rust
    match: \b0x[\da-fA-F_]+(i128|i16|i32|i64|i8|isize|u128|u16|u32|u64|u8|usize)?\b
    captures:
      1:
        name: entity.name.type.numeric.rust
  -
    comment: octal integers
    name: constant.numeric.oct.rust
    match: \b0o[0-7_]+(i128|i16|i32|i64|i8|isize|u128|u16|u32|u64|u8|usize)?\b
    captures:
      1:
        name: entity.name.type.numeric.rust
  -
    comment: binary integers
    name: constant.numeric.bin.rust
    match: \b0b[01_]+(i128|i16|i32|i64|i8|isize|u128|u16|u32|u64|u8|usize)?\b
    captures:
      1:
        name: entity.name.type.numeric.rust
  # constant.language
  -
    comment: booleans
    name: constant.language.bool.rust
    match: \btrue|false\b
  # types
  -
    comment: numeric types
    name: entity.name.type.numeric
    match: (f32|f64|i128|i16|i32|i64|i8|isize|u128|u16|u32|u64|u8|usize)
  # punctuation
  # meta scopes
  -
    comment: attributes
    name: meta.attribute.rust
    begin: '(#)(\!?)(\[)'
    beginCaptures:
      1:
        name: punctuation.definition.attribute.rust
      2:
        name: keyword.operator.attribute.inner.rust
      3:
        name: punctuation.brackets.attribute.rust
    end: '\]'
    endCaptures:
      0:
        name: punctuation.brackets.attribute.rust
    patterns:
      - include: '#keywords'
      - include: '#punctuation'
      - include: '#strings'
repository:
  comments:
    patterns:
      -
        comment: documentation comments
        name: comment.line.documentation.rust
        match: ^\s*///.*
        patterns:
          - include: '#comments'
      -
        comment: line comments
        name: comment.line.double-slash.rust
        match: \s*//.*
        patterns:
          - include: '#comments'
      -
        comment: block comments
        name: comment.block.rust
        begin: /\*(?!\*)
        end: \*/
        patterns:
          - include: '#comments'
      -
        comment: block documentation comments
        name: comment.block.documentation.rust
        begin: /\*\*
        end: \*/
        patterns:
          - include: '#comments'
  escapes:
    comment: 'escapes: ASCII, byte, Unicode, quote, regex'
    name: constant.character.escape.rust
    match: (\\)(?:(?:(x[0-7][0-7a-fA-F])|(u(\{)[\da-fA-F]{4,6}(\}))|.))
    captures:
      1:
        name: constant.character.escape.backslash.rust
      2:
        name: constant.character.escape.bit.rust
      3:
        name: constant.character.escape.unicode.rust
      4:
        name: constant.character.escape.unicode.punctuation.rust
      5:
        name: constant.character.escape.unicode.punctuation.rust
  keywords:
    patterns:
      -
        comment: control flow keywords
        name: keyword.control.rust
        match: \b(abstract|as|async|await|become|box|break|const|continue|do|dyn|else|enum|extern|final|for|if|impl|in|let|loop|macro|match|mod|move|override|priv|pub|ref|return|static|struct|trait|try|type|typeof|union|unsafe|unsized|use|virtual|where|while|yield)\b
      -
        comment: fn
        name: keyword.control.fn.rust
        match: \bfn\b
      # keyword.other
      -
        comment: crate
        name: keyword.other.crate.rust
        match: \bcrate\b
      -
        comment: mut
        name: keyword.other.mut.rust
        match: \bmut\b
      -
        comment: super
        name: keyword.other.super.rust
        match: \bsuper\b
      # keyword.operator
      -
        comment: math operators
        name: keyword.operator.math.rust
        match: '(([+%]|(\*(?!\w)))(?!=))|(-(?!>))|(/(?!/))'
      -
        comment: logical operators
        name: keyword.operator.logical.rust
        match: (\^|\||\|\||&&|<<|>>)(?!=)
      -
        comment: macro bang and not
        name: keyword.operator.macro.not.rust
        match: '!(?!=)'
      -
        comment: logical AND, borrow references
        name: keyword.operator.borrow.and.rust
        match: '&(?![&=])'
      -
        comment: assignment operators
        name: keyword.operator.assignment.rust
        match: (-=|\*=|/=|%=|\^=|&=|\|=|<<=|>>=)
      -
        comment: single equal
        name: keyword.operator.assignment.equal.rust
        match: '(?<![<>])=(?!=|>)'
      -
        comment: comparison operators
        name: keyword.operator.comparison.rust
        match: (==|!=|<=?|(?<!=)>=?)
      -
        comment: namespace operator
        name: keyword.operator.namespace.rust
        match: '::'
      -
        # note: you could replace the zero length assertion here with a capture that scopes the dereferenced variable, but this way the scope of whatever is dereferenced shines through
        comment: dereference asterisk
        match: (\*)(?=\w+)
        captures:
          1:
            name: keyword.operator.dereference.rust
      -
        comment: subpattern bindng
        name: keyword.operator.subpattern.rust
        match: '@'
      -
        comment: dot access
        name: keyword.operator.access.dot.rust
        match: \.(?!\.)
      -
        comment: ranges, range patterns
        name: keyword.operator.range.rust
        match: \.{2}(=|\.)?
      -
        comment: colon
        name: keyword.operator.key-value.rust
        match: ':(?!:)'
      -
        comment: dashrocket, skinny arrow
        name: keyword.operator.arrow.skinny.rust
        match: ->
      -
        comment: hashrocket, fat arrow
        name: keyword.operator.arrow.fat.rust
        match: =>
      -
        comment: dollar macros
        name: keyword.operator.macro.dollar.rust
        match: \$
      -
        comment: question mark operator, questionably sized, macro kleene matcher
        name: keyword.operator.question.rust
        match: \?
  interpolations:
    comment: curly brace interpolations
    name: meta.interpolation.rust
    begin: '{'
    beginCaptures:
      0:
        name: punctuation.definition.interpolation.rust
    end: '}'
    endCaptures:
      0:
        name: punctuation.definition.interpolation.rust
  lifetimes:
    patterns:
      -
        comment: named lifetime parameters
        match: (['])([a-zA-Z_][0-9a-zA-Z_]*)(?!['])\b
        captures:
          1:
            name: punctuation.definition.lifetime.rust
          2:
            name: entity.name.type.lifetime.rust
      -
        comment: borrowing references to named lifetimes
        match: (\&)(['])([a-zA-Z_][0-9a-zA-Z_]*)(?!['])\b
        captures:
          1:
            name: keyword.operator.borrow.rust
          2:
            name: punctuation.definition.lifetime.rust
          3:
            name: entity.name.type.lifetime.rust
  punctuation:
    patterns:
      -
        comment: comma
        name: punctuation.comma.rust
        match: ','
      -
        comment: curly braces
        name: punctuation.braces.rust
        match: '[{}]'
      -
        comment: parentheses
        name: punctuation.parentheses.rust
        match: '[()]'
      -
        comment: semicolon
        name: punctuation.semi.rust
        match: ;
      -
        comment: square brackets
        name: punctuation.brackets.square.rust
        match: '[\[\]]'
  strings:
    patterns:
      -
        comment: double-quoted strings and byte strings
        name: string.quoted.double.rust
        begin: '(b?)(")'
        beginCaptures:
          1:
            name: string.quoted.byte.raw.rust
          2:
            name: punctuation.definition.string.rust
        end: '"'
        endCaptures:
          0:
            name: punctuation.definition.string.rust
        patterns:
          - include: '#escapes'
          - include: '#interpolations'
      -
        comment: double-quoted raw strings and raw byte strings
        name: string.quoted.double.rust
        begin: '(b?r)(#*)(")'
        beginCaptures:
          1:
            name: string.quoted.byte.raw.rust
          2:
            name: punctuation.definition.string.raw.rust
          3:
            name: punctuation.definition.string.rust
        end: '(")(#*)'
        endCaptures:
          1:
            name: punctuation.definition.string.rust
          2:
            name: punctuation.definition.string.raw.rust
      -
        comment: characters and bytes
        name: string.quoted.single.char.rust
        begin: "(b)?(')"
        beginCaptures:
          1:
            name: string.quoted.byte.raw.rust
          2:
            name: punctuation.definition.char.rust
        end: "'"
        endCaptures:
          0:
            name: punctuation.definition.char.rust
        patterns:
          - include: '#escapes'

# ALL_CAPS_CONSTANTS
# true declared constants
# numeric constants, unicode values, hex, octal, binary
# language constants - self or __module__-like things
